import { NextRequest, NextResponse } from 'next/server'
import { openai } from '@ai-sdk/openai'
import { generateText } from 'ai'

// ç¬¬ä¸€æ­¥ï¼šè¯­è¨€æ•´ç†Prompt
const LANGUAGE_CLEANUP_PROMPT = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è¯­è¨€è§„æ•´å¸ˆï¼Œè´Ÿè´£å°†ç”¨æˆ·çš„ç¢ç‰‡åŒ–è¾“å…¥è½¬æ¢ä¸ºè§„èŒƒã€å®Œæ•´çš„æ‹›è˜è¯­å¥ã€‚

ğŸ¯ **æ ¸å¿ƒç†è§£è§„åˆ™**ï¼š
âœ… **å…¬å¸åç§°è¾“å…¥ = å¯»æ‰¾å€™é€‰äºº**ï¼š
  - "å°ç±³é€šè®¯æŠ€æœ¯æœ‰é™å…¬å¸æœºå™¨äººäº‹ä¸šéƒ¨" â†’ "å¯»æ‰¾åœ¨å°ç±³é€šè®¯æŠ€æœ¯æœ‰é™å…¬å¸æœºå™¨äººäº‹ä¸šéƒ¨å·¥ä½œçš„å€™é€‰äºº"
  - "è…¾è®¯äº‘è®¡ç®—" â†’ "å¯»æ‰¾åœ¨è…¾è®¯äº‘è®¡ç®—å·¥ä½œçš„å€™é€‰äºº"  
  - "å­—èŠ‚è·³åŠ¨" â†’ "å¯»æ‰¾åœ¨å­—èŠ‚è·³åŠ¨å·¥ä½œçš„å€™é€‰äºº"
  - "åä¸ºæŠ€æœ¯ç ”å‘éƒ¨" â†’ "å¯»æ‰¾åœ¨åä¸ºæŠ€æœ¯ç ”å‘éƒ¨å·¥ä½œçš„å€™é€‰äºº"

âœ… **æ‹›è˜éœ€æ±‚è¡¨è¾¾**ï¼š
  - "æ‹›è˜Javaå·¥ç¨‹å¸ˆ" â†’ "æ‹›è˜Javaå·¥ç¨‹å¸ˆ"
  - "éœ€è¦å‰ç«¯å¼€å‘" â†’ "æ‹›è˜å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ"
  - "æ‰¾ä¸ªäº§å“ç»ç†" â†’ "æ‹›è˜äº§å“ç»ç†"

âœ… **æ±‚èŒè¡¨è¾¾**ï¼š
  - "æˆ‘æƒ³æ‰¾Javaå·¥ä½œ" â†’ "å¯»æ‰¾Javaå¼€å‘å·¥ç¨‹å¸ˆèŒä½"
  - "æˆ‘æ˜¯å‰ç«¯å·¥ç¨‹å¸ˆ" â†’ "å¯»æ‰¾å‰ç«¯å·¥ç¨‹å¸ˆèŒä½"

ğŸ“ **æ•´ç†è§„åˆ™**ï¼š
1. å°†ç¢ç‰‡åŒ–è¾“å…¥è½¬æ¢ä¸ºå®Œæ•´è¯­å¥
2. ä¿æŒç”¨æˆ·åŸæ„ä¸å˜
3. ä½¿ç”¨æ ‡å‡†çš„æ‹›è˜è¯­è¨€
4. ä¸è¦æ·»åŠ ç”¨æˆ·æ²¡æœ‰æåˆ°çš„è¦æ±‚
5. ä¸è¦æ”¹å˜æœç´¢ç›®æ ‡ï¼ˆæ‰¾äºº vs æ‰¾å·¥ä½œï¼‰

âš ï¸ **ä¸¥ç¦è½¬æ¢ç”¨æˆ·æ„å›¾**ï¼š
- ç”¨æˆ·è¾“å…¥å…¬å¸å â‰  æ‹›è˜è¯¥å…¬å¸èŒä½
- ç”¨æˆ·è¾“å…¥å…¬å¸å = å¯»æ‰¾åœ¨è¯¥å…¬å¸å·¥ä½œçš„å€™é€‰äºº

**ç¤ºä¾‹**ï¼š
è¾“å…¥ï¼š"5å¹´java ç”· 32"
è¾“å‡ºï¼š"å¯»æ‰¾32å²çš„ç”·æ€§å·¥ç¨‹å¸ˆï¼Œå…·å¤‡5å¹´Javaå¼€å‘ç»éªŒ"

è¾“å…¥ï¼š"å°ç±³é€šè®¯æŠ€æœ¯æœ‰é™å…¬å¸æœºå™¨äººäº‹ä¸šéƒ¨"  
è¾“å‡ºï¼š"å¯»æ‰¾åœ¨å°ç±³é€šè®¯æŠ€æœ¯æœ‰é™å…¬å¸æœºå™¨äººäº‹ä¸šéƒ¨å·¥ä½œçš„å€™é€‰äºº"

è¾“å…¥ï¼š"æ‹›è˜å‰ç«¯å·¥ç¨‹å¸ˆï¼Œè¦æ±‚React"
è¾“å‡ºï¼š"æ‹›è˜å‰ç«¯å·¥ç¨‹å¸ˆï¼Œè¦æ±‚å…·å¤‡ReactæŠ€èƒ½"

è¾“å…¥ï¼š"æˆ‘æƒ³æ‰¾äº§å“ç»ç†çš„å·¥ä½œ"
è¾“å‡ºï¼š"å¯»æ‰¾äº§å“ç»ç†èŒä½"`

// ç¬¬äºŒæ­¥ï¼šç»“æ„åŒ–è§£æPrompt  
const STRUCTURED_PARSING_PROMPT = `âš ï¸ **æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ - å¿…é¡»ä¸¥æ ¼éµå®ˆ**ï¼š
- role å­—æ®µï¼šå°†ç”¨æˆ·è¾“å…¥çš„èŒä½åˆ«åè½¬æ¢ä¸ºå”¯ä¸€èŒƒå¼ï¼Œä¿æŒæ•°æ®åº“æ£€ç´¢çš„ä¸€è‡´æ€§
- skills_must å­—æ®µï¼šå°†ç”¨æˆ·æåˆ°çš„æŠ€èƒ½åˆ«åè½¬æ¢ä¸ºæ ‡å‡†æœ¯è¯­ï¼Œç¡®ä¿å‘é‡åŒ¹é…ç²¾åº¦
- ç¤ºä¾‹ï¼šè¾“å…¥"HRD" â†’ role:["äººåŠ›èµ„æºæ€»ç›‘"]ï¼›è¾“å…¥"k8s" â†’ skills_must:["Kubernetes"]

ä½ æ˜¯ä¸€ä½æ‹›è˜æœç´¢ä¸“å®¶ï¼Œè´Ÿè´£æŠŠç”¨æˆ·çš„æŸ¥è¯¢è¯­å¥è§£æå¹¶**æ ‡å‡†åŒ–ä¸ºç»Ÿä¸€èŒƒå¼**ï¼Œä»¥ç¡®ä¿å‘é‡æ£€ç´¢çš„å‡†ç¡®æ€§ã€‚

ğŸ¯ **å…³é”®ç†è§£è§„åˆ™ï¼ˆæ–°å¢ï¼‰**ï¼š
âœ… **å…¬å¸åç§°è¾“å…¥ = å¯»æ‰¾å€™é€‰äºº**ï¼š
  - "å°ç±³é€šè®¯æŠ€æœ¯æœ‰é™å…¬å¸æœºå™¨äººäº‹ä¸šéƒ¨" â†’ å¯»æ‰¾åœ¨è¯¥å…¬å¸å·¥ä½œçš„å€™é€‰äºº
  - "è…¾è®¯äº‘è®¡ç®—" â†’ å¯»æ‰¾åœ¨è…¾è®¯äº‘è®¡ç®—å·¥ä½œçš„å€™é€‰äºº
  - "å­—èŠ‚è·³åŠ¨" â†’ å¯»æ‰¾åœ¨å­—èŠ‚è·³åŠ¨å·¥ä½œçš„å€™é€‰äºº
  - search_type å¿…é¡»æ˜¯ "candidate"
  - rewritten_query æ·»åŠ  #å…¬å¸å #éƒ¨é—¨å å…³é”®è¯

âœ… **å¢å¼ºå‘é‡æœç´¢**ï¼š
  - åœ¨ rewritten_query ä¸­æ·»åŠ  # æ ‡ç­¾æ¥å¼ºåŒ–å…³é”®ä¿¡æ¯
  - æ ¼å¼ï¼šåŸå§‹æŸ¥è¯¢ + #å…³é”®è¯1 #å…³é”®è¯2
  - ä¾‹å¦‚ï¼š"å¯»æ‰¾åœ¨å°ç±³é€šè®¯æŠ€æœ¯æœ‰é™å…¬å¸æœºå™¨äººäº‹ä¸šéƒ¨å·¥ä½œçš„å€™é€‰äºº #å°ç±³ #æœºå™¨äºº #é€šè®¯æŠ€æœ¯"

ğŸ¯ **æ ‡å‡†åŒ–è§„åˆ™ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰**ï¼š
âœ… èŒä½æ ‡å‡†åŒ–ï¼šHRD â†’ äººåŠ›èµ„æºæ€»ç›‘ã€CTO â†’ é¦–å¸­æŠ€æœ¯å®˜ã€CEO â†’ é¦–å¸­æ‰§è¡Œå®˜
âœ… æŠ€èƒ½æ ‡å‡†åŒ–ï¼šk8s â†’ Kubernetesã€docker â†’ Dockerã€ps â†’ Photoshop
âœ… ç›®æ ‡ï¼šæ•°æ®åº“å­˜å‚¨å’ŒæŸ¥è¯¢ä½¿ç”¨ç›¸åŒçš„æœ¯è¯­ä½“ç³»ï¼Œç¡®ä¿ç²¾ç¡®åŒ¹é…

âš™ï¸ è¾“å‡ºå”¯ä¸€ JSONï¼Œé”®é¡ºåºå›ºå®šï¼š
{
  "search_type": "candidate" | "job",
  "role": [string],               // ğŸ¯ è½¬æ¢ä¸ºæ ‡å‡†æœ¯è¯­ï¼ŒHRDâ†’äººåŠ›èµ„æºæ€»ç›‘ï¼ŒCTOâ†’é¦–å¸­æŠ€æœ¯å®˜
  "skills_must": [string],        // ğŸ¯ è½¬æ¢ä¸ºæ ‡å‡†æœ¯è¯­ï¼Œk8sâ†’Kubernetesï¼Œdockerâ†’Docker
  "skills_related": [             // ç”±æ¨¡å‹æ¨æ–­çš„ç›¸å…³/åŒä¹‰æŠ€èƒ½ï¼ŒæŒ‰é‡è¦åº¦é™åº
    { "skill": string, "confidence": 1-5 }
  ],
  "location": [string],
  "industry": [string],
  "experience_min": int|null,
  "experience_max": int|null,
  "salary_min": int|null,
  "salary_max": int|null,
  "education": [string],
  "company": [string],
  "gender": string|null,
  "age_min": int|null,
  "age_max": int|null,
  "rewritten_query": string       // å¢å¼ºæŸ¥è¯¢ï¼ŒåŒ…å«#å…³é”®è¯æ ‡ç­¾
}

ğŸ”¥ **å…³é”®ä¿®å¤ - è–ªèµ„è§£æè§„åˆ™ (åŠ¡å¿…éµå®ˆ)ï¼š**
â€¢ salary_min/salary_max ç»Ÿä¸€ä»¥æœˆè–ªå…ƒä¸ºå•ä½ï¼š
  - "25k" / "25K" â†’ 25000 (æœˆè–ª)
  - "3w" / "3ä¸‡" â†’ 30000 (æœˆè–ª)
  - "25-35k" â†’ salary_min: 25000, salary_max: 35000
  - "å¹´è–ª36ä¸‡" â†’ salary_min: 30000, salary_max: 30000 (36ä¸‡Ã·12æœˆ)
  - "å¹´è–ª60-80ä¸‡" â†’ salary_min: 50000, salary_max: 66667 (é™¤ä»¥12)
  - "æœˆè–ª15000" â†’ salary_min: 15000, salary_max: 15000
  - è‹¥åªæœ‰å•ä¸ªæ•°å€¼ï¼Œminå’Œmaxè®¾ä¸ºç›¸åŒå€¼
  - è‹¥æ— æ˜ç¡®è–ªèµ„ä¿¡æ¯ï¼Œè®¾ä¸ºnull

ğŸ¯ **è§’è‰²æ ‡å‡†åŒ–è§„åˆ™ï¼š**
â€¢ **è½¬æ¢ä¸ºå”¯ä¸€èŒƒå¼**ï¼šå°†æ‰€æœ‰èŒä½åˆ«åè½¬æ¢ä¸ºæ ‡å‡†ä¸­æ–‡æœ¯è¯­
â€¢ **æ ‡å‡†åŒ–æ˜ å°„è¡¨**ï¼š
  - HRD â†’ äººåŠ›èµ„æºæ€»ç›‘
  - CTO â†’ é¦–å¸­æŠ€æœ¯å®˜  
  - CEO â†’ é¦–å¸­æ‰§è¡Œå®˜
  - CFO â†’ é¦–å¸­è´¢åŠ¡å®˜
  - COO â†’ é¦–å¸­è¿è¥å®˜
  - CPO â†’ é¦–å¸­äº§å“å®˜
â€¢ **ä»èŒä½åæå–æŠ€èƒ½**ï¼šå¦‚"Javaå·¥ç¨‹å¸ˆ" â†’ role=["Javaå·¥ç¨‹å¸ˆ"], skills_must=["Java"]

ğŸ’ª **æŠ€èƒ½æ ‡å‡†åŒ–è§„åˆ™ï¼ˆå‡çº§ç‰ˆï¼‰ï¼š**
â€¢ **ç¡¬æŠ€èƒ½æ ‡å‡†åŒ–**ï¼š
  - "k8s" â†’ skills_must: ["Kubernetes"] (æ ‡å‡†åŒ–)
  - "docker" â†’ skills_must: ["Docker"] (æ ‡å‡†åŒ–)
  - "ps" â†’ skills_must: ["Photoshop"] (æ ‡å‡†åŒ–)
  - "ai" â†’ skills_must: ["Illustrator"] (æ ‡å‡†åŒ–)
  - ä»èŒä½åç§°ä¸­æå–ï¼šå¦‚"Javaå·¥ç¨‹å¸ˆ" â†’ role=["Javaå·¥ç¨‹å¸ˆ"], skills_must=["Java"]

â€¢ **ã€æ–°å¢ã€‘è½¯æŠ€èƒ½ä¸æŠ½è±¡èƒ½åŠ›è¯†åˆ«**ï¼š
  ä»æè¿°æ€§è¯­è¨€ä¸­æ™ºèƒ½æå–å¹¶æ ‡å‡†åŒ–è½¯æŠ€èƒ½ï¼š
  - "æ²Ÿé€šèƒ½åŠ›å¼º" â†’ skills_must: ["æ²Ÿé€šèƒ½åŠ›"]
  - "æœ‰è¾ƒå¼ºçš„é€»è¾‘æ€ç»´èƒ½åŠ›" â†’ skills_must: ["é€»è¾‘æ€ç»´èƒ½åŠ›"]
  - "æŠ—å‹èƒ½åŠ›" â†’ skills_must: ["æŠ—å‹èƒ½åŠ›"]
  - "èƒ½è·Ÿå¼€å‘æ’•é€¼é‚£ç§" â†’ (æ¨æ–­) skills_must: ["æ²Ÿé€šèƒ½åŠ›", "åè°ƒèƒ½åŠ›"]
  - "ç»“æœå¯¼å‘" â†’ skills_must: ["ç»“æœå¯¼å‘"]
  - "å–œæ¬¢teamwork" â†’ skills_must: ["å›¢é˜Ÿåˆä½œèƒ½åŠ›"]
  - "æ€§æ ¼å¼€æœ—" â†’ skills_must: ["æ²Ÿé€šèƒ½åŠ›"]
  - "æœ‰è´£ä»»å¿ƒ" â†’ skills_must: ["è´£ä»»å¿ƒ"]
  - "å­¦ä¹ èƒ½åŠ›å¼º" â†’ skills_must: ["å­¦ä¹ èƒ½åŠ›"]
  - "è‹±æ–‡è¯»å†™èƒ½åŠ›" â†’ skills_must: ["è‹±è¯­èƒ½åŠ›"]
  - "é¡¹ç›®ç®¡ç†èƒ½åŠ›" â†’ skills_must: ["é¡¹ç›®ç®¡ç†"]
  - "åˆ†æé—®é¢˜è§£å†³é—®é¢˜" â†’ skills_must: ["é—®é¢˜è§£å†³èƒ½åŠ›"]

ğŸ“Œ **skills_related æ™ºèƒ½è¡¥å…¨è§„åˆ™ï¼ˆå…¨é¢å‡çº§ï¼‰**ï¼š
â€¢ **ç»¼åˆæŠ€èƒ½æ‰©å±•åº“**ï¼š
  - **å‰ç«¯å¼€å‘**: React, Vue, Angular, HTML, CSS, JavaScript, TypeScript, Webpack, å“åº”å¼è®¾è®¡
  - **åç«¯å¼€å‘**: Java, Spring, Python, Django, Node.js, Express, APIè®¾è®¡, å¾®æœåŠ¡
  - **æ•°æ®åº“**: MySQL, PostgreSQL, MongoDB, Redis, æ•°æ®åº“è®¾è®¡, SQLä¼˜åŒ–
  - **äº‘åŸç”Ÿ**: Docker, Kubernetes, AWS, é˜¿é‡Œäº‘, è…¾è®¯äº‘, DevOps, CI/CD
  - **ç§»åŠ¨ç«¯**: iOS, Android, Flutter, React Native, ç§»åŠ¨ç«¯ä¼˜åŒ–
  - **è®¾è®¡ç±»**: Figma, Sketch, Photoshop, Illustrator, åŸå‹è®¾è®¡, ç”¨æˆ·ä½“éªŒè®¾è®¡, äº¤äº’è®¾è®¡, è§†è§‰è®¾è®¡
  - **AI/ML**: TensorFlow, PyTorch, æœºå™¨å­¦ä¹ , æ·±åº¦å­¦ä¹ , NLP, è®¡ç®—æœºè§†è§‰, æ•°æ®æŒ–æ˜
  - **äº§å“ç®¡ç†**: éœ€æ±‚åˆ†æ, PRDæ’°å†™, äº§å“è§„åˆ’, ç”¨æˆ·ç ”ç©¶, ç«å“åˆ†æ, æ•°æ®åˆ†æ, A/Bæµ‹è¯•
  - **é¡¹ç›®ç®¡ç†**: æ•æ·å¼€å‘, Scrum, é¡¹ç›®è§„åˆ’, é£é™©ç®¡ç†, å›¢é˜Ÿç®¡ç†, PMP
  - **è¿è¥ç±»**: å†…å®¹è¿è¥, ç”¨æˆ·è¿è¥, æ´»åŠ¨ç­–åˆ’, ç¤¾ç¾¤è¿è¥, å¢é•¿é»‘å®¢
  - **é”€å”®ç±»**: å®¢æˆ·å¼€å‘, é”€å”®æŠ€å·§, å•†åŠ¡è°ˆåˆ¤, CRMç³»ç»Ÿ, æ¸ é“ç®¡ç†
  - **è½¯æŠ€èƒ½**: æ²Ÿé€šèƒ½åŠ›, å›¢é˜Ÿåˆä½œ, é¢†å¯¼åŠ›, åˆ›æ–°æ€ç»´, æŠ—å‹èƒ½åŠ›, å­¦ä¹ èƒ½åŠ›, æ‰§è¡ŒåŠ›

â€¢ **ã€æ‰©å±•ã€‘å²—ä½å…³è”æŠ€èƒ½æ¨æ–­**ï¼š
  - "äº§å“ç»ç†" â†’ skills_related: [{"skill": "éœ€æ±‚åˆ†æ", "confidence": 5}, {"skill": "ç”¨æˆ·ç ”ç©¶", "confidence": 4}, {"skill": "æ•°æ®åˆ†æ", "confidence": 4}, {"skill": "æ²Ÿé€šèƒ½åŠ›", "confidence": 5}]
  - "UIè®¾è®¡å¸ˆ" â†’ skills_related: [{"skill": "ç”¨æˆ·ä½“éªŒè®¾è®¡", "confidence": 5}, {"skill": "äº¤äº’è®¾è®¡", "confidence": 4}, {"skill": "è§†è§‰è®¾è®¡", "confidence": 5}, {"skill": "å®¡ç¾èƒ½åŠ›", "confidence": 4}]
  - "Javaå·¥ç¨‹å¸ˆ" â†’ skills_related: [{"skill": "Spring", "confidence": 4}, {"skill": "MySQL", "confidence": 4}, {"skill": "é—®é¢˜è§£å†³èƒ½åŠ›", "confidence": 3}]
  - "é”€å”®ç»ç†" â†’ skills_related: [{"skill": "å®¢æˆ·å¼€å‘", "confidence": 5}, {"skill": "å•†åŠ¡è°ˆåˆ¤", "confidence": 5}, {"skill": "æ²Ÿé€šèƒ½åŠ›", "confidence": 5}, {"skill": "æŠ—å‹èƒ½åŠ›", "confidence": 4}]
  - "è¿è¥ä¸“å‘˜" â†’ skills_related: [{"skill": "å†…å®¹è¿è¥", "confidence": 4}, {"skill": "æ•°æ®åˆ†æ", "confidence": 4}, {"skill": "åˆ›æ–°æ€ç»´", "confidence": 3}]

â€¢ **è½¯æŠ€èƒ½æ¨æ–­ç¤ºä¾‹**ï¼š
  - "æ²Ÿé€šèƒ½åŠ›å¼º" â†’ skills_related: [{"skill": "å›¢é˜Ÿåˆä½œèƒ½åŠ›", "confidence": 4}, {"skill": "åè°ƒèƒ½åŠ›", "confidence": 4}, {"skill": "è¡¨è¾¾èƒ½åŠ›", "confidence": 5}]
  - "æŠ—å‹èƒ½åŠ›" â†’ skills_related: [{"skill": "æ‰§è¡ŒåŠ›", "confidence": 4}, {"skill": "æ—¶é—´ç®¡ç†", "confidence": 3}, {"skill": "æƒ…ç»ªç®¡ç†", "confidence": 4}]
  - "å­¦ä¹ èƒ½åŠ›å¼º" â†’ skills_related: [{"skill": "é€‚åº”èƒ½åŠ›", "confidence": 4}, {"skill": "åˆ›æ–°æ€ç»´", "confidence": 3}, {"skill": "è‡ªæˆ‘é©±åŠ¨", "confidence": 4}]
  - "å›¢é˜Ÿåˆä½œ" â†’ skills_related: [{"skill": "æ²Ÿé€šèƒ½åŠ›", "confidence": 5}, {"skill": "åè°ƒèƒ½åŠ›", "confidence": 4}, {"skill": "é›†ä½“è£èª‰æ„Ÿ", "confidence": 3}]
  
â€¢ **ç»¼åˆæ¨æ–­ç¤ºä¾‹ï¼ˆç¡¬æŠ€èƒ½+è½¯æŠ€èƒ½ï¼‰**ï¼š
  - "k8s" â†’ skills_related: [{"skill": "Kubernetes", "confidence": 5}, {"skill": "Docker", "confidence": 4}, {"skill": "é—®é¢˜è§£å†³èƒ½åŠ›", "confidence": 3}]
  - "Java" â†’ skills_related: [{"skill": "Spring", "confidence": 4}, {"skill": "MySQL", "confidence": 3}, {"skill": "é€»è¾‘æ€ç»´èƒ½åŠ›", "confidence": 3}]
  - "å‰ç«¯" â†’ skills_related: [{"skill": "HTML", "confidence": 5}, {"skill": "CSS", "confidence": 5}, {"skill": "å®¡ç¾èƒ½åŠ›", "confidence": 3}]

â€¢ **confidence è¯„åˆ†æ ‡å‡†**ï¼š
  - 5: å¿…ç„¶ç›¸å…³ (k8sâ†’Kubernetes, HTMLâ†’CSS, æ²Ÿé€šèƒ½åŠ›â†’è¡¨è¾¾èƒ½åŠ›)
  - 4: é«˜åº¦ç›¸å…³ (Reactâ†’TypeScript, Javaâ†’Spring, æŠ—å‹èƒ½åŠ›â†’æ‰§è¡ŒåŠ›) 
  - 3: ä¸­åº¦ç›¸å…³ (å‰ç«¯â†’Vue, Pythonâ†’Django, å­¦ä¹ èƒ½åŠ›â†’åˆ›æ–°æ€ç»´)
  - 2: ä½åº¦ç›¸å…³ (Javaâ†’Kotlin, ç¼–ç¨‹â†’ç®—æ³•, æŠ€æœ¯â†’æ—¶é—´ç®¡ç†)
  - 1: å¯èƒ½ç›¸å…³ (æŠ€æœ¯â†’é¡¹ç›®ç®¡ç†, è®¾è®¡â†’å•†ä¸šæ€ç»´)

ğŸ“Œ å…¶ä»–å­—æ®µè§„åˆ™ï¼š
â€¢ search_type åˆ¤æ–­ (å…³é”®è§„åˆ™ï¼Œå¿…é¡»å‡†ç¡®)ï¼š
  - candidate (ä¼ä¸šæ‰¾äººé€‰): æ‹›è˜ã€å¯»æ‰¾ã€éœ€è¦ã€è¦æ±‚ + JDæ–‡æœ¬ã€å²—ä½æè¿°ã€æŠ€èƒ½è¦æ±‚ + **å…¬å¸åç§°ç›´æ¥è¾“å…¥**
  - job (ä¸ªäººæ±‚èŒ): æˆ‘æ˜¯ã€æˆ‘æƒ³æ‰¾ã€å¸Œæœ›ã€æƒ³åœ¨...æ‰¾å·¥ä½œã€æ±‚èŒã€åº”å±Šç”Ÿã€å®ä¹ ç”Ÿã€å…¼èŒã€æµ·å½’
  - æ³¨æ„: JDæ–‡æœ¬å’Œæ‹›è˜å¹¿å‘Šéƒ½æ˜¯candidateç±»å‹ï¼**å…¬å¸åç§°è¾“å…¥é»˜è®¤ä¸ºcandidateç±»å‹ï¼**
â€¢ experience: ç›´æ¥æå–å¹´é™æ•°å­—ï¼Œå¦‚"5å¹´ä»¥ä¸Š"â†’5
â€¢ age/gender: "ç”·æ€§"â†’"ç”·"ï¼Œ"å¥³æ€§"â†’"å¥³"
â€¢ education: æ ‡å‡†åŒ–å­¦å† "æœ¬ç§‘"ã€"ç¡•å£«"ã€"åšå£«"
â€¢ location: æå–åŸå¸‚åï¼Œå¦‚"åŒ—äº¬æœé˜³åŒº"â†’"åŒ—äº¬"
â€¢ rewritten_query ä½¿ç”¨æ•´ç†åçš„è§„èŒƒè¯­å¥ï¼Œ**å¿…é¡»æ·»åŠ #å…³é”®è¯æ ‡ç­¾**

âš ï¸ **å†æ¬¡å¼ºè°ƒï¼šrole å’Œ skills_must å­—æ®µå¿…é¡»ä¸ç”¨æˆ·è¾“å…¥å®Œå…¨ä¸€è‡´ï¼**

ğŸ“Œ **æ­£ç¡®ç¤ºä¾‹ï¼ˆä¸¥æ ¼éµå¾ªï¼‰**ï¼š

è¾“å…¥1ï¼š"å°ç±³é€šè®¯æŠ€æœ¯æœ‰é™å…¬å¸æœºå™¨äººäº‹ä¸šéƒ¨"
âœ… æ­£ç¡®è¾“å‡ºï¼š{
  "search_type": "candidate",                    // â† å…¬å¸åç§°è¾“å…¥=å¯»æ‰¾å€™é€‰äºº
  "role": [],                                   // â† æœªæ˜ç¡®èŒä½
  "skills_must": [],                            // â† æœªæ˜ç¡®æŠ€èƒ½
  "skills_related": [
    { "skill": "æœºå™¨äººæŠ€æœ¯", "confidence": 5 },
    { "skill": "ç®—æ³•", "confidence": 4 },
    { "skill": "äººå·¥æ™ºèƒ½", "confidence": 4 }
  ],
  "company": ["å°ç±³é€šè®¯æŠ€æœ¯æœ‰é™å…¬å¸"],
  "industry": ["é€šä¿¡", "æœºå™¨äºº"],
  "rewritten_query": "å¯»æ‰¾åœ¨å°ç±³é€šè®¯æŠ€æœ¯æœ‰é™å…¬å¸æœºå™¨äººäº‹ä¸šéƒ¨å·¥ä½œçš„å€™é€‰äºº #å°ç±³ #æœºå™¨äºº #é€šè®¯æŠ€æœ¯"  // â† æ·»åŠ #æ ‡ç­¾
}

è¾“å…¥2ï¼š"HRDæ‹›è˜ï¼Œéœ€è¦HRç®¡ç†ç»éªŒ"
âœ… æ­£ç¡®è¾“å‡ºï¼š{
  "search_type": "candidate",
  "role": ["äººåŠ›èµ„æºæ€»ç›‘"],           // â† æ ‡å‡†åŒ–ï¼šHRD â†’ äººåŠ›èµ„æºæ€»ç›‘
  "skills_must": ["HRç®¡ç†"],          // â† ä¿æŒåŸè¾“å…¥
  "skills_related": [
    { "skill": "äººåŠ›èµ„æºç®¡ç†", "confidence": 5 },
    { "skill": "æ‹›è˜", "confidence": 4 }
  ],
  "rewritten_query": "æ‹›è˜äººåŠ›èµ„æºæ€»ç›‘ï¼Œéœ€è¦HRç®¡ç†ç»éªŒ #HRD #äººåŠ›èµ„æº #ç®¡ç†"
}

è¾“å…¥3ï¼š"è…¾è®¯äº‘è®¡ç®—"
âœ… æ­£ç¡®è¾“å‡ºï¼š{
  "search_type": "candidate",                    // â† å…¬å¸åç§°=å€™é€‰äººæœç´¢
  "company": ["è…¾è®¯"],
  "industry": ["äº‘è®¡ç®—"],
  "skills_related": [
    { "skill": "äº‘è®¡ç®—", "confidence": 5 },
    { "skill": "åˆ†å¸ƒå¼ç³»ç»Ÿ", "confidence": 4 }
  ],
  "rewritten_query": "å¯»æ‰¾åœ¨è…¾è®¯äº‘è®¡ç®—å·¥ä½œçš„å€™é€‰äºº #è…¾è®¯ #äº‘è®¡ç®—"
}

âŒ **ç¦æ­¢çš„é”™è¯¯ç¤ºä¾‹**ï¼š
è¾“å…¥ï¼š"å°ç±³é€šè®¯æŠ€æœ¯æœ‰é™å…¬å¸æœºå™¨äººäº‹ä¸šéƒ¨"
âŒ é”™è¯¯ï¼š{ "search_type": "job", "rewritten_query": "æ‹›è˜å°ç±³é€šè®¯æŠ€æœ¯æœ‰é™å…¬å¸æœºå™¨äººäº‹ä¸šéƒ¨ç›¸å…³èŒä½" }
âœ… æ­£ç¡®ï¼š{ "search_type": "candidate", "rewritten_query": "å¯»æ‰¾åœ¨å°ç±³é€šè®¯æŠ€æœ¯æœ‰é™å…¬å¸æœºå™¨äººäº‹ä¸šéƒ¨å·¥ä½œçš„å€™é€‰äºº #å°ç±³ #æœºå™¨äºº #é€šè®¯æŠ€æœ¯" }`

export async function POST(request: NextRequest) {
  try {
    const { query } = await request.json()

    if (!query || typeof query !== 'string') {
      return NextResponse.json(
        { error: 'Query is required and must be a string' },
        { status: 400 }
      )
    }

    console.log('ğŸ” åŸå§‹ç”¨æˆ·è¾“å…¥:', query)

    // ç¬¬ä¸€æ­¥ï¼šè¯­è¨€æ•´ç†
    console.log('ğŸ“ å¼€å§‹è¯­è¨€æ•´ç†...')
    const cleanupResult = await generateText({
      model: openai('gpt-4o-mini'),
      system: LANGUAGE_CLEANUP_PROMPT,
      prompt: query,
      temperature: 0.1,
      maxTokens: 200
    })

    const cleanedQuery = cleanupResult.text.trim()
    console.log('âœ¨ æ•´ç†åè¯­å¥:', cleanedQuery)

    // ç¬¬äºŒæ­¥ï¼šç»“æ„åŒ–è§£æ
    console.log('ğŸ” å¼€å§‹ç»“æ„åŒ–è§£æ...')
    const parseResult = await generateText({
      model: openai('gpt-4o-mini'),
      system: STRUCTURED_PARSING_PROMPT,
      prompt: cleanedQuery,
      temperature: 0.1,
      maxTokens: 500
    })

    console.log('ğŸ¤– LLMè§£æè¾“å‡º:', parseResult.text)

    // å°è¯•è§£æJSON
    let parsedResult
    try {
      parsedResult = JSON.parse(parseResult.text.trim())
      
      // ä¸è¦è¦†ç›–ç¬¬äºŒæ­¥LLMè¾“å‡ºçš„rewritten_queryï¼Œå› ä¸ºå®ƒåŒ…å«#æ ‡ç­¾å¢å¼º
      // parsedResult.rewritten_query = cleanedQuery  // â† åˆ é™¤è¿™è¡Œï¼Œä¿ç•™LLMçš„å¢å¼ºæŸ¥è¯¢
      
      // ç¡®ä¿æ•°ç»„å­—æ®µæ ¼å¼æ­£ç¡®
      if (typeof parsedResult.location === 'string') {
        parsedResult.location = [parsedResult.location]
      }
    } catch (parseError) {
      console.error('âŒ JSONè§£æå¤±è´¥:', parseError)
      console.error('åŸå§‹è¾“å‡º:', parseResult.text)
      
      // å›é€€æ–¹æ¡ˆï¼šè¿”å›åŸºç¡€ç»“æ„ï¼Œä½†ä½¿ç”¨æ•´ç†åçš„è¯­å¥
      parsedResult = {
        search_type: "candidate",
        role: [],
        skills_must: [],
        skills_nice: [],
        industry: [],
        location: [],
        experience_min: null,
        experience_max: null,
        education: [],
        salary_min: null,
        salary_max: null,
        company: [],
        gender: null,
        age_min: null,
        age_max: null,
        rewritten_query: cleanedQuery
      }
    }

    console.log('âœ… æœ€ç»ˆè§£æç»“æœ:', parsedResult)

    return NextResponse.json({
      success: true,
      data: parsedResult,
      meta: {
        original_query: query,
        cleaned_query: cleanedQuery,
        processing_steps: ['language_cleanup', 'structured_parsing']
      }
    })

  } catch (error) {
    console.error('âŒ è¯­å¥è§£æAPIé”™è¯¯:', error)
    return NextResponse.json(
      { 
        error: 'Failed to parse query',
        details: error instanceof Error ? error.message : 'Unknown error'
      },
      { status: 500 }
    )
  }
} 