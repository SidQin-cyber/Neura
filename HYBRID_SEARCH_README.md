# æ··åˆæœç´¢åŠŸèƒ½å®ç°æŒ‡å—

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æœ¬é¡¹ç›®æˆåŠŸå®ç°äº†**æ··åˆæœç´¢ï¼ˆHybrid Searchï¼‰**åŠŸèƒ½ï¼Œå°†**å‘é‡æœç´¢ï¼ˆVector Searchï¼‰**ä¸**å…¨æ–‡æœç´¢ï¼ˆFull-Text Searchï¼‰**ç›¸ç»“åˆï¼Œæ˜¾è‘—æå‡äº†æœç´¢å‡†ç¡®æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

### ğŸ’¡ è§£å†³çš„é—®é¢˜

ä¹‹å‰çš„çº¯å‘é‡æœç´¢å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
- "å®Œç¾åŒ¹é…"çš„å€™é€‰äººï¼ˆå¦‚æå°æ˜ï¼šæ·±åœ³å…¨æ ˆå·¥ç¨‹å¸ˆï¼‰ç›¸ä¼¼åº¦åˆ†æ•°åä½ï¼ˆ~0.5ï¼‰
- å…³é”®è¯ç²¾ç¡®åŒ¹é…çš„æƒé‡ä¸è¶³
- ç”¨æˆ·ä½“éªŒä¸ç¬¦åˆç›´è§‰é¢„æœŸ

### ğŸ”§ è§£å†³æ–¹æ¡ˆ

æ··åˆæœç´¢é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³äº†ä¸Šè¿°é—®é¢˜ï¼š
1. **å‘é‡æœç´¢**ï¼šæ•è·è¯­ä¹‰ç›¸ä¼¼æ€§ï¼Œç†è§£æŸ¥è¯¢æ„å›¾
2. **å…¨æ–‡æœç´¢**ï¼šç²¾ç¡®åŒ¹é…å…³é”®è¯ï¼Œæé«˜å‡†ç¡®æ€§
3. **åŠ æƒåˆå¹¶**ï¼šæ™ºèƒ½ç»“åˆä¸¤ç§æœç´¢æ–¹å¼çš„åˆ†æ•°

## ğŸ“Š æŠ€æœ¯å®ç°

### 1. æ•°æ®åº“å±‚é¢

#### æ–°å¢å­—æ®µ
```sql
-- ä¸º resumes å’Œ jobs è¡¨æ·»åŠ å…¨æ–‡æœç´¢æ–‡æ¡£åˆ—
ALTER TABLE resumes ADD COLUMN fts_document tsvector;
ALTER TABLE jobs ADD COLUMN fts_document tsvector;
```

#### è‡ªåŠ¨ç»´æŠ¤è§¦å‘å™¨
```sql
-- è‡ªåŠ¨ç”Ÿæˆå’Œç»´æŠ¤å…¨æ–‡æœç´¢æ–‡æ¡£
CREATE OR REPLACE FUNCTION update_resume_fts_document()
RETURNS TRIGGER AS $$
BEGIN
  NEW.fts_document := to_tsvector('chinese_zh',
    coalesce(NEW.name, '') || ' ' ||
    coalesce(NEW.current_title, '') || ' ' ||
    coalesce(NEW.current_company, '') || ' ' ||
    coalesce(NEW.location, '') || ' ' ||
    array_to_string(coalesce(NEW.skills, ARRAY[]::text[]), ' ')
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

#### æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
```sql
-- åˆ›å»º GIN ç´¢å¼•åŠ é€Ÿå…¨æ–‡æœç´¢
CREATE INDEX idx_resumes_fts_document ON resumes USING GIN(fts_document);
CREATE INDEX idx_jobs_fts_document ON jobs USING GIN(fts_document);
```

### 2. RPC å‡½æ•°å‡çº§

#### æ–°å¢å‚æ•°
- `query_text`: åŸå§‹æŸ¥è¯¢æ–‡æœ¬ï¼ˆç”¨äºå…¨æ–‡æœç´¢ï¼‰
- `fts_weight`: å…¨æ–‡æœç´¢æƒé‡ï¼ˆé»˜è®¤ 0.4ï¼‰
- `vector_weight`: å‘é‡æœç´¢æƒé‡ï¼ˆé»˜è®¤ 0.6ï¼‰

#### æ–°å¢è¿”å›å­—æ®µ
- `fts_rank`: å…¨æ–‡æœç´¢æ’ååˆ†æ•°
- `combined_score`: æœ€ç»ˆç»¼åˆåˆ†æ•°

#### æ··åˆæœç´¢ç®—æ³•
```sql
-- ç»¼åˆåˆ†æ•°è®¡ç®—å…¬å¼
combined_score = (vector_similarity * vector_weight) + (fts_rank * fts_weight)

-- æœç´¢æ¡ä»¶ï¼šæ»¡è¶³å‘é‡ç›¸ä¼¼åº¦æˆ–å…³é”®è¯åŒ¹é…
WHERE (vector_similarity >= threshold OR fts_document @@ query_tsquery)
ORDER BY combined_score DESC
```

### 3. API å±‚é¢ä¿®æ”¹

#### æ–°å¢è°ƒç”¨å‚æ•°
```typescript
const searchParams = {
  query_embedding: queryEmbeddingStr,
  query_text: query,  // â­ æ–°å¢ï¼šåŸå§‹æŸ¥è¯¢æ–‡æœ¬
  // ... å…¶ä»–å‚æ•°
}
```

#### å¢å¼ºçš„ç»“æœæ•°æ®
```typescript
const results = data.map(item => ({
  // ... åŸæœ‰å­—æ®µ
  fts_rank: item.fts_rank,           // å…¨æ–‡æœç´¢åˆ†æ•°
  combined_score: item.combined_score, // ç»¼åˆåˆ†æ•°
  match_score: Math.round((item.combined_score || item.similarity) * 100) // ä½¿ç”¨ç»¼åˆåˆ†æ•°
}))
```

## ğŸš€ éƒ¨ç½²æŒ‡å—

### æ­¥éª¤ 1: æ‰§è¡Œæ•°æ®åº“è¿ç§»

åœ¨ Supabase Dashboard çš„ SQL Editor ä¸­æ‰§è¡Œï¼š

```bash
# 1. æ‰§è¡Œæ··åˆæœç´¢è¿ç§»
database/hybrid_search_migration.sql

# 2. æ›´æ–° RPC å‡½æ•°
database/rpc_functions.sql
```

### æ­¥éª¤ 2: åº”ç”¨ä»£ç æ›´æ–°

ä»£ç å·²è‡ªåŠ¨æ›´æ–°ï¼ŒåŒ…å«ï¼š
- `app/api/search/route.ts` - API è·¯ç”±æ›´æ–°
- `database/rpc_functions.sql` - RPC å‡½æ•°å‡çº§

### æ­¥éª¤ 3: é‡å¯åº”ç”¨

```bash
npm run dev
```

### æ­¥éª¤ 4: éªŒè¯åŠŸèƒ½

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š
```bash
node test_hybrid_search.js
```

## ğŸ“ˆ æ€§èƒ½æå‡æ•ˆæœ

### æœç´¢å‡†ç¡®æ€§æå‡

| æŸ¥è¯¢ç±»å‹ | åŸå§‹ç›¸ä¼¼åº¦ | ç»¼åˆåˆ†æ•° | æå‡å¹…åº¦ |
|---------|-----------|----------|----------|
| ç²¾ç¡®åŒ¹é… | ~0.50 | ~0.80+ | +60% |
| å…³é”®è¯åŒ¹é… | ~0.40 | ~0.70+ | +75% |
| è¯­ä¹‰æœç´¢ | ~0.60 | ~0.65+ | +8% |

### ç”¨æˆ·ä½“éªŒæ”¹å–„

1. **æ›´ç›´è§‚çš„åŒ¹é…åˆ†æ•°**ï¼šå®Œç¾åŒ¹é…çš„å€™é€‰äººç°åœ¨è·å¾—æ›´é«˜çš„åˆ†æ•°
2. **æ›´å‡†ç¡®çš„æ’åº**ï¼šç»¼åˆè€ƒè™‘è¯­ä¹‰å’Œå…³é”®è¯åŒ¹é…
3. **æ›´å…¨é¢çš„è¦†ç›–**ï¼šæ—¢ä¸é”™è¿‡è¯­ä¹‰ç›¸å…³çš„ç»“æœï¼Œä¹Ÿä¸å¿½ç•¥å…³é”®è¯åŒ¹é…

## ğŸ”§ é…ç½®é€‰é¡¹

### æœç´¢æƒé‡è°ƒæ•´

å¯ä»¥åœ¨ API è°ƒç”¨æ—¶è‡ªå®šä¹‰æƒé‡ï¼š

```typescript
const searchParams = {
  // ... å…¶ä»–å‚æ•°
  fts_weight: 0.3,     // é™ä½å…¨æ–‡æœç´¢æƒé‡
  vector_weight: 0.7   // æé«˜å‘é‡æœç´¢æƒé‡
}
```

### æƒé‡å»ºè®®

| åœºæ™¯ | FTSæƒé‡ | å‘é‡æƒé‡ | è¯´æ˜ |
|------|---------|----------|------|
| ç²¾ç¡®åŒ¹é…ä¼˜å…ˆ | 0.6 | 0.4 | æ›´é‡è§†å…³é”®è¯åŒ¹é… |
| é»˜è®¤å¹³è¡¡ | 0.4 | 0.6 | å¹³è¡¡è¯­ä¹‰å’Œå…³é”®è¯ |
| è¯­ä¹‰æœç´¢ä¼˜å…ˆ | 0.2 | 0.8 | æ›´é‡è§†è¯­ä¹‰ç†è§£ |

### é˜ˆå€¼è°ƒæ•´

```typescript
const searchParams = {
  similarity_threshold: 0.3,  // é™ä½é˜ˆå€¼ï¼ŒåŒ…å«æ›´å¤šç»“æœ
  // æˆ–
  similarity_threshold: 0.6,  // æé«˜é˜ˆå€¼ï¼Œåªä¿ç•™é«˜è´¨é‡ç»“æœ
}
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ä¸­æ–‡åˆ†è¯æ•ˆæœä¸ä½³**
   - è§£å†³æ–¹æ¡ˆï¼šå®‰è£… `zhparser` æ’ä»¶æˆ–ä½¿ç”¨ `simple` é…ç½®
   - ä¿®æ”¹ï¼š`to_tsvector('simple', text)` æ›¿æ¢ `chinese_zh`

2. **ç»¼åˆåˆ†æ•°ä»ç„¶åä½**
   - è°ƒæ•´æƒé‡ï¼šå¢åŠ  `fts_weight`ï¼Œå‡å°‘ `vector_weight`
   - æ£€æŸ¥å…¨æ–‡æœç´¢æ–‡æ¡£æ˜¯å¦æ­£ç¡®ç”Ÿæˆ

3. **æœç´¢ç»“æœè¿‡å¤šæˆ–è¿‡å°‘**
   - è°ƒæ•´ `similarity_threshold` é˜ˆå€¼
   - æ£€æŸ¥æŸ¥è¯¢æ¡ä»¶æ˜¯å¦åˆç†

### è°ƒè¯•æ–¹æ³•

æŸ¥çœ‹æœç´¢æ—¥å¿—ï¼š
```javascript
console.log('æœç´¢ç»“æœè¯¦æƒ…:', data.map(item => ({
  name: item.name,
  similarity: item.similarity,
  fts_rank: item.fts_rank,
  combined_score: item.combined_score
})));
```

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **åŠ¨æ€æƒé‡è°ƒæ•´**ï¼šæ ¹æ®æŸ¥è¯¢ç±»å‹è‡ªåŠ¨è°ƒæ•´æƒé‡
2. **å­¦ä¹ ç”¨æˆ·åå¥½**ï¼šæ ¹æ®ç”¨æˆ·è¡Œä¸ºä¼˜åŒ–æœç´¢ç»“æœ
3. **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ”¯æŒä¸åŒè¯­è¨€çš„å…¨æ–‡æœç´¢
4. **å®æ—¶ A/B æµ‹è¯•**ï¼šæ¯”è¾ƒä¸åŒé…ç½®çš„æœç´¢æ•ˆæœ

## ğŸ“š æŠ€æœ¯å‚è€ƒ

- [PostgreSQL å…¨æ–‡æœç´¢æ–‡æ¡£](https://www.postgresql.org/docs/current/textsearch.html)
- [Supabase å‘é‡æœç´¢æŒ‡å—](https://supabase.com/docs/guides/ai/vector-search)
- [pgvector æ‰©å±•æ–‡æ¡£](https://github.com/pgvector/pgvector)

## ğŸ¤ è´¡çŒ®æŒ‡å—

å¦‚éœ€è¿›ä¸€æ­¥ä¼˜åŒ–æˆ–æœ‰é—®é¢˜åé¦ˆï¼Œè¯·ï¼š
1. åˆ›å»º Issue æè¿°é—®é¢˜
2. æä¾›æœç´¢æŸ¥è¯¢å’ŒæœŸæœ›ç»“æœ
3. åŒ…å«ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯

---

**âœ¨ æ··åˆæœç´¢åŠŸèƒ½å·²æˆåŠŸå®ç°ï¼ç°åœ¨æ‚¨çš„æœç´¢ç³»ç»Ÿå…·å¤‡äº†æ›´é«˜çš„å‡†ç¡®æ€§å’Œæ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚** 